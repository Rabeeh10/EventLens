rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    /// Checks if the requesting user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /// Checks if the requesting user is an admin
    /// This is the CRITICAL security check for all admin operations
    /// 
    /// PROTECTION: Prevents privilege escalation attacks
    /// - Fetches role from database (not client-provided data)
    /// - Uses get() to read user document atomically
    /// - Cannot be bypassed even if attacker modifies client code
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    /// Checks if the requesting user is accessing their own document
    /// 
    /// PROTECTION: Prevents users from accessing other users' data
    /// - Compares authenticated UID with document ID
    /// - UID is provided by Firebase Auth (trusted source)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /// Checks if a field is being modified in an update operation
    /// 
    /// PROTECTION: Prevents unauthorized field modifications
    /// - Detects which fields are changing in an update
    /// - Allows selective field protection (e.g., role field)
    function isFieldModified(field) {
      return request.resource.data.diff(resource.data).affectedKeys().hasAny([field]);
    }
    
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    // PROTECTION: User profile data isolation
    // - Users cannot see other users' personal data (email, phone, etc.)
    // - Users cannot promote themselves to admin
    // - Admin role changes must be done by existing admins
    
    match /users/{userId} {
      // Users can read their own document
      // Admins can read all user documents (for user management)
      // CRITICAL: Allow users to read own document without admin check to prevent circular dependency
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own document during registration
      // PROTECTION: 
      // - Must set role to 'user' (prevents self-promotion to admin)
      // - Email must match authenticated email (prevents impersonation)
      allow create: if isOwner(userId) && 
                      request.resource.data.role == 'user' &&
                      request.resource.data.email == request.auth.token.email;
      
      // Users can update their own profile EXCEPT the role field
      // Only admins can change user roles
      // PROTECTION:
      // - Prevents privilege escalation (user promoting self to admin)
      // - Allows normal profile updates (name, photo, preferences)
      allow update: if (isOwner(userId) && !isFieldModified('role')) || 
                      isAdmin();
      
      // Only admins can delete user documents
      // PROTECTION: Prevents account deletion by unauthorized parties
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // EVENTS COLLECTION
    // ============================================================================
    // PROTECTION: Event data integrity and admin-only management
    // - Prevents users from creating fake events
    // - Prevents event data manipulation
    // - Ensures only published events are visible to general public
    
    match /events/{eventId} {
      // REQUIREMENT: Users can only READ event data
      // All authenticated users can view events
      allow read: if isAuthenticated();
      
      // REQUIREMENT: Admins can WRITE events
      // Only admins can create events
      // PROTECTION:
      // - Validates required fields exist (prevents malformed data)
      // - Ensures dates are present for scheduling
      allow create: if isAdmin() &&
                      request.resource.data.keys().hasAll(['name', 'description', 'start_date', 'end_date']);
      
      // Only admins can update events
      // PROTECTION: Prevents users from:
      // - Changing event details (date, location, capacity)
      // - Modifying pricing or registration requirements
      allow update: if isAdmin();
      
      // Only admins can delete events
      // PROTECTION: Prevents data loss from malicious deletion
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // STALLS COLLECTION (Vendor Booths)
    // ============================================================================
    // PROTECTION: Stall configuration and admin-only management
    // - Prevents unauthorized booth creation
    // - Ensures stall assignments are controlled
    // - Protects vendor information and booth details
    
    match /stalls/{stallId} {
      // REQUIREMENT: Users can only READ stall data
      // Authenticated users can view stall information (for navigation/AR)
      allow read: if isAuthenticated();
      
      // REQUIREMENT: Admins can WRITE stalls
      // Only admins can create stalls
      // PROTECTION:
      // - Validates stall belongs to valid event
      // - Ensures required fields (name, location, marker_id) are present
      allow create: if isAdmin() &&
                      request.resource.data.keys().hasAll(['event_id', 'name', 'location', 'marker_id']);
      
      // Only admins can update stalls
      // PROTECTION: Prevents users from:
      // - Changing stall assignments
      // - Modifying vendor information
      // - Altering AR markers or location data
      allow update: if isAdmin();
      
      // Only admins can delete stalls
      // PROTECTION: Prevents unauthorized booth removal
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // MEDIA COLLECTION (Event Images, Banners)
    // ============================================================================
    
    match /media/{mediaId} {
      // Authenticated users can read media
      allow read: if isAuthenticated();
      
      // Only admins can upload media
      allow create: if isAdmin() &&
                      request.resource.data.keys().hasAll(['url', 'type', 'eventId']) &&
                      request.resource.data.uploadedBy == request.auth.uid;
      
      // Only admins can update media metadata
      allow update: if isAdmin();
      
      // Only admins can delete media
      allow delete: if isAdmin();
    }
    
    
    // ============================================================================
    // REGISTRATIONS COLLECTION (User Activity Data)
    // ============================================================================
    // REQUIREMENT: Users can write only their own activity data
    // PROTECTION: User activity data isolation and ownership
    // - Users cannot see other users' registrations
    // - Users cannot register on behalf of others
    // - Users cannot modify/delete other users' registrations
    
    match /registrations/{registrationId} {
      // Users can read their own registrations
      // Admins can read all registrations (for event management)
      // PROTECTION: Privacy - users cannot see who else registered
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                    isAdmin();
      
      // REQUIREMENT: Users can write their own activity data
      // Authenticated users can register for events
      // PROTECTION:
      // - userId must match authenticated user (prevents fake registrations)
      // - Validates required fields exist
      // - Prevents registration bombing (someone registering others)
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['eventId', 'userId', 'registeredAt']);
      
      // Users can update their own registrations (e.g., check-in status, dietary preferences)
      // Admins can update any registration (e.g., manual check-in)
      // PROTECTION: Prevents users from modifying other users' registration status
      allow update: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                      isAdmin();
      
      // Users can delete their own registrations (cancel registration)
      // Admins can delete any registration
      // PROTECTION: Users can only cancel their own registrations
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                      isAdmin();
    }
    
    
    // ============================================================================
    // AR SCANS COLLECTION (User Activity Data)
    // ============================================================================
    // REQUIREMENT: Users can write only their own activity data
    // PROTECTION: AR usage tracking and user privacy
    // - Users cannot see other users' scan history
    // - Users cannot log scans on behalf of others
    // - Scan data used for analytics (aggregated, anonymous)
    
    match /arScans/{scanId} {
      // Users can read their own AR scans (view history)
      // Admins can read all scans (for analytics and engagement metrics)
      // PROTECTION: Privacy - users cannot see where others scanned
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                    isAdmin();
      
      // REQUIREMENT: Users can write their own activity data
      // Authenticated users can log AR scans
      // PROTECTION:
      // - userId must match authenticated user (prevents fake scan data)
      // - Validates required fields (stallId, userId, timestamp)
      // - Prevents scan history manipulation
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['stallId', 'userId', 'scannedAt']);
      
      // Only admins can update scans (for moderation or data correction)
      // PROTECTION: Prevents users from manipulating scan timestamps or locations
      allow update: if isAdmin();
      
      // Users can delete their own scans (privacy control)
      // Admins can delete any scan (moderation)
      // PROTECTION: Users control their own activity data
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                      isAdmin();
    }
    
    
    // ============================================================================
    // ANALYTICS COLLECTION (Aggregated Statistics)
    // ============================================================================
    
    match /analytics/{analyticsId} {
      // Only admins can read analytics
      allow read: if isAdmin();
      
      // Only admins can write analytics
      // (Should typically be written by Cloud Functions, not clients)
      allow create, update, delete: if isAdmin();
    }
    
    
    // ============================================================================
    // DEFAULT DENY
    // ============================================================================
    
    // Deny all other access by default
    // This ensures new collections are secure by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
